<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Dino Game</title>
	<style>
		body {
			background: white;
			margin: 0;
			text-align: center;
		}
		canvas {
			border: 1px solid black;
			margin-top: 20px;
		}
	</style>
</head>
<body>
	<h1>Dino Game</h1>
	<canvas id="game" width="800" height="600"></canvas>

	<script>
		const canvas = document.getElementById('game') ;
		const ctx = canvas.getContext('2d') ;
		
		const socket = new WebSocket('ws://localhost:3001') ;
		let playerId = null ;
		let gameState = null ;

		const TYPE_CACTUS	= 1 ;
		const TYPE_SMALL	= 2 ;
		const TYPE_GROUP	= 3 ;
		const TYPE_PTERO	= 4 ;
/*

export const PLAYER_WIDTH		= 48 ;
export const PLAYER_HEIGHT		= 48 ;

export const CACTUS_WIDTH		= 32 ;
export const CACTUS_HEIGHT		= 48 ;

export const SMALL_WIDTH		= 16 ;
export const SMALL_HEIGHT		= 32 ;

export const GROUP_WIDTH		= 48 ;
export const GROUP_HEIGHT		= 48 ;

export const PTERO_WIDTH		= 48 ;
export const PTERO_HEIGHT		= 48 ;

*/
		
		const DINO_WIDTH = 48 ; const DINO_HEIGHT = 48 ;
		const dinoImage = new Image() ;
		dinoImage.src = 'img/dino_standing.png' ;
		
		const CACTUS_WIDTH = 32 ; const CACTUS_HEIGHT = 48 ;
		const cactusImage = new Image() ;
		cactusImage.src = 'img/cactus.png' ;
		
		const SMALL_WIDTH = 16 ; const SMALL_HEIGHT = 32 ;
		const smallImage = new Image() ;
		smallImage.src = 'img/cactus_small.png' ;
		
		const GROUP_WIDTH = 48 ; const GROUP_HEIGHT = 48 ;
		const groupImage = new Image() ;
		groupImage.src = 'img/cactus_group.png' ;
		
		const PTERO_WIDTH = 48 ; const PTERO_HEIGHT = 48 ;
		const pteroImage = new Image() ;
		pteroImage.src = 'img/ptero1.png' ;
		
		const keysPressed = {
			jump: false,
			fall: false
		} ;
	
		socket.addEventListener('open', () => {
			console.log('Connected to server') ;
		}) ;
	
		socket.addEventListener('message', event => {
			const msg = JSON.parse(event.data) ;
	
			if (msg.type === 'assign') {
				playerId = msg.playerId ;
				console.log(`You are player ${playerId}`) ;
			}
	
			if (msg.type === 'state')
				gameState = msg.gameState ;
		});
	
		function drawGame() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
	
			if (!gameState) return ;
	
			const offset = 600 / (gameState.dinos.length + 1) ; // TODO: find a way to make this prettier

			ctx.fillStyle = '#555' ;
			let i = 1 ;
			gameState.dinos.forEach(dino => {
				ctx.fillRect(20, (offset * i), (canvas.width - 40), 2) ;
				
				if (dinoImage.complete) {
					ctx.drawImage(dinoImage, 40, ((offset * i) - DINO_HEIGHT - dino.y), DINO_WIDTH, DINO_HEIGHT) ;
				}

				gameState.obstacles.forEach(obstacle => {
					if (obstacle.type === TYPE_CACTUS && cactusImage.complete)
						ctx.drawImage(cactusImage, obstacle.x, ((offset * i) - obstacle.y), CACTUS_WIDTH, CACTUS_HEIGHT) ;
					else if (obstacle.type === TYPE_SMALL && smallImage.complete)
						ctx.drawImage(smallImage, obstacle.x, ((offset * i) - obstacle.y), SMALL_WIDTH, SMALL_HEIGHT) ;
					else if (obstacle.type === TYPE_GROUP && groupImage.complete)
						ctx.drawImage(groupImage, obstacle.x, ((offset * i) - obstacle.y), GROUP_WIDTH, GROUP_HEIGHT) ;
					else if (obstacle.type === TYPE_PTERO && pteroImage.complete)
						ctx.drawImage(pteroImage, obstacle.x, ((offset * i) - obstacle.y), PTERO_WIDTH, PTERO_HEIGHT) ;
				})

				i++ ;
			}) ;
	
			// // Draw scores
			// ctx.font = '24px Arial';
			// ctx.fillText(`${gameState.left_team.score}`, 300, 40);
			// ctx.fillText(`${gameState.right_team.score}`, 480, 40);
		}
	
		// Send movement updates based on key states
		function handleInput() {
			if (!playerId) return ;
	
			if (keysPressed.jump) socket.send(JSON.stringify({ type: 'jump', playerId })) ;
			
			if (keysPressed.fall) socket.send(JSON.stringify({ type: 'fall', playerId })) ;
		}
	
		// Game loop
		function gameLoop() {
			drawGame() ;
			handleInput() ;
			requestAnimationFrame(gameLoop) ;
		}
	
		gameLoop() ;
	
		// Keyboard controls (no delay)
		document.addEventListener('keydown', e => {
			if (e.key === 'ArrowUp' || e.key === ' ') keysPressed.jump = true ;
			if (e.key === 'ArrowDown') keysPressed.fall = true ;
		}) ;
	
		document.addEventListener('keyup', e => {
			if (e.key === 'ArrowUp' || e.key === ' ') keysPressed.jump = false ;
			if (e.key === 'ArrowDown') keysPressed.fall = false ;
		}) ;
	</script>
</body>
</html>
