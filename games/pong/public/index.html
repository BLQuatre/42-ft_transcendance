<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Pong Game</title>
	<style>
		body {
			background: white;
			margin: 0;
			text-align: center;
		}
		canvas {
			border: 1px solid black;
			margin-top: 20px;
		}
	</style>
</head>
<body>
	<h1>Pong Game</h1>
	<canvas id="game" width="800" height="600"></canvas>

	<script>
		const canvas = document.getElementById('game');
		const ctx = canvas.getContext('2d');
	
		const socket = new WebSocket('ws://localhost:3000');
		let playerId = null;
		let gameState = null;
	
		const keysPressed = {
			up: false,
			down: false
		};
	
		socket.addEventListener('open', () => {
			console.log('Connected to server');
		});
	
		socket.addEventListener('message', event => {
			const msg = JSON.parse(event.data);
	
			if (msg.type === 'assign') {
				playerId = msg.playerId;
				console.log(`You are player ${playerId}`);
			}
	
			if (msg.type === 'state') {
				gameState = msg.gameState;
			}
		});
	
		function drawGame() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
	
			if (!gameState) return ;
	
			// Draw paddles
			ctx.fillStyle = 'black' ;
			gameState.left_team.players.forEach(player => {
				ctx.fillRect(20, player.top, 20, (player.bot - player.top)) ;
						/*	xSRT,	ySRT,	xLEN,	yLEN	*/ // TODO: find a way to make this prettier
			}) ;
			gameState.right_team.players.forEach(player => {
				ctx.fillRect(760, player.top, 20, (player.bot - player.top)) ;
						/*	xSRT,	ySRT,	xLEN,	yLEN	*/
			}) ;
	
			// Draw ball
			ctx.beginPath();
			ctx.arc(gameState.ball.x, gameState.ball.y, 10, 0, Math.PI * 2);
			ctx.fill();
	
			// Draw scores
			ctx.font = '24px Arial';
			ctx.fillText(`${gameState.left_team.score}`, 300, 40);
			ctx.fillText(`${gameState.right_team.score}`, 480, 40);
		}
	
		// Send movement updates based on key states
		function handleInput() {
			if (!playerId) return;
	
			if (keysPressed.up) {
				socket.send(JSON.stringify({ type: 'move', playerId, direction: 'up' }));
			}
			if (keysPressed.down) {
				socket.send(JSON.stringify({ type: 'move', playerId, direction: 'down' }));
			}
		}
	
		// Game loop
		function gameLoop() {
			drawGame();
			handleInput();
			requestAnimationFrame(gameLoop);
		}
	
		gameLoop();
	
		// Keyboard controls (no delay)
		document.addEventListener('keydown', e => {
			if (e.key === 'ArrowUp' || e.key === 'w') keysPressed.up = true;
			if (e.key === 'ArrowDown' || e.key === 's') keysPressed.down = true;
		});
	
		document.addEventListener('keyup', e => {
			if (e.key === 'ArrowUp' || e.key === 'w') keysPressed.up = false;
			if (e.key === 'ArrowDown' || e.key === 's') keysPressed.down = false;
		});
	</script>	
</body>
</html>
